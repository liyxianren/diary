<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重置密码 - CBT情绪日记游戏</title>
    <meta name="description" content="重置您的CBT情绪日记游戏账号密码">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-heart-pulse"></i>
                CBT情绪日记游戏
            </a>
            <div class="d-flex gap-2">
                <a href="/login" class="btn btn-outline">返回登录</a>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-5 col-md-7">
                    <!-- 重置密码表单 -->
                    <div class="form-container animate-fade-in-up">
                        <div class="text-center mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
                                 style="width: 80px; height: 80px; background: var(--gradient-primary);">
                                <i class="fas fa-key text-white" style="font-size: 2rem;"></i>
                            </div>
                            <h1 class="form-title">重置密码</h1>
                            <p class="text-gray-600">
                                请设置您的新密码，确保账号安全
                            </p>
                        </div>

                        <!-- 错误/成功提示 -->
                        <div id="alertContainer"></div>

                        <form id="resetPasswordForm" novalidate>
                            <!-- 新密码 -->
                            <div class="form-group">
                                <label for="newPassword" class="form-label">
                                    <i class="fas fa-lock me-2"></i>新密码
                                </label>
                                <div class="input-group">
                                    <input type="password"
                                           class="form-control"
                                           id="newPassword"
                                           name="new_password"
                                           placeholder="请输入新密码"
                                           required
                                           minlength="6">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                        <i class="fas fa-eye" id="newPasswordIcon"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    密码至少需要6个字符
                                </div>
                                <div class="mt-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-gray-600">密码强度</small>
                                        <small id="newStrengthText" class="text-gray-500">--</small>
                                    </div>
                                    <div class="progress" style="height: 4px;">
                                        <div id="newStrengthBar" class="progress-bar" role="progressbar"
                                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 确认新密码 -->
                            <div class="form-group">
                                <label for="confirmNewPassword" class="form-label">
                                    <i class="fas fa-lock me-2"></i>确认新密码
                                </label>
                                <div class="input-group">
                                    <input type="password"
                                           class="form-control"
                                           id="confirmNewPassword"
                                           name="confirm_new_password"
                                           placeholder="请再次输入新密码"
                                           required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    两次输入的密码不一致
                                </div>
                            </div>

                            <!-- 重置按钮 -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="resetBtn">
                                    <i class="fas fa-check me-2"></i>
                                    <span id="resetBtnText">确认重置密码</span>
                                </button>
                            </div>

                            <!-- 安全提示 -->
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>
                                    密码安全提示：<br>
                                    • 使用至少6个字符<br>
                                    • 包含大小写字母、数字和特殊字符<br>
                                    • 避免使用常见的密码模式
                                </small>
                            </div>
                        </form>

                        <!-- 返回登录链接 -->
                        <div class="text-center mt-4">
                            <p class="text-gray-600 mb-0">
                                想起密码了？
                                <a href="/login" class="text-primary text-decoration-none fw-semibold">
                                    返回登录
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        // 获取URL中的token
        const urlParams = new URLSearchParams(window.location.search);
        const token = "{{ token }}"; // 从模板变量获取token

        // 密码显示/隐藏切换
        function setupPasswordToggle(toggleId, inputId, iconId) {
            const toggleBtn = document.getElementById(toggleId);
            const passwordInput = document.getElementById(inputId);
            const passwordIcon = document.getElementById(iconId);

            if (toggleBtn && passwordInput && passwordIcon) {
                toggleBtn.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    passwordIcon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
                });
            }
        }

        setupPasswordToggle('toggleNewPassword', 'newPassword', 'newPasswordIcon');
        setupPasswordToggle('toggleConfirmPassword', 'confirmNewPassword', 'confirmPasswordIcon');

        // 密码强度检测
        function checkPasswordStrength(password) {
            let strength = 0;
            const strengthBar = document.getElementById('newStrengthBar');
            const strengthText = document.getElementById('newStrengthText');

            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            const strengthLevels = [
                { width: '0%', color: 'bg-danger', text: '弱' },
                { width: '20%', color: 'bg-danger', text: '很弱' },
                { width: '40%', color: 'bg-warning', text: '一般' },
                { width: '60%', color: 'bg-info', text: '较强' },
                { width: '80%', color: 'bg-primary', text: '强' },
                { width: '100%', color: 'bg-success', text: '很强' }
            ];

            const level = strengthLevels[strength] || strengthLevels[0];
            strengthBar.style.width = level.width;
            strengthBar.className = `progress-bar ${level.color}`;
            strengthBar.setAttribute('aria-valuenow', parseInt(level.width));
            strengthText.textContent = level.text;
            strengthText.className = level.color.replace('bg-', 'text-');
        }

        // 表单验证
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

        newPasswordInput.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });

        function validateResetForm() {
            let isValid = true;

            // 新密码验证
            if (newPasswordInput.value.length < 6) {
                newPasswordInput.classList.add('is-invalid');
                isValid = false;
            } else {
                newPasswordInput.classList.remove('is-invalid');
            }

            // 确认密码验证
            if (confirmNewPasswordInput.value !== newPasswordInput.value) {
                confirmNewPasswordInput.classList.add('is-invalid');
                isValid = false;
            } else {
                confirmNewPasswordInput.classList.remove('is-invalid');
            }

            return isValid;
        }

        // 实时验证
        ['newPassword', 'confirmNewPassword'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('blur', function() {
                validateResetForm();
            });
        });

        // 表单提交
        resetPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validateResetForm()) {
                showAlert('请检查并修正表单中的错误', 'danger');
                return;
            }

            if (!token) {
                showAlert('无效的重置链接', 'danger');
                return;
            }

            const resetBtn = document.getElementById('resetBtn');
            const resetBtnText = document.getElementById('resetBtnText');

            // 显示加载状态
            resetBtn.disabled = true;
            resetBtnText.innerHTML = '<span class="loading me-2"></span>重置中...';

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reset_token: token,
                        new_password: newPasswordInput.value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('密码重置成功！正在跳转到登录页面...', 'success');

                    // 延迟跳转，让用户看到成功消息
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showAlert(data.error || '重置失败，请重试', 'danger');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showAlert('网络错误，请重试', 'danger');
            } finally {
                // 恢复按钮状态
                resetBtn.disabled = false;
                resetBtnText.innerHTML = '<i class="fas fa-check me-2"></i>确认重置密码';
            }
        });

        // 显示提示信息
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);

            // 自动消失
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // 输入时清除错误状态
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        });

        // 页面加载动画
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('.form-container').classList.add('animate-fade-in-up');

            // 检查token是否存在
            if (!token) {
                showAlert('无效的重置链接，请重新申请', 'danger');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
            }
        });
    </script>
</body>
</html>